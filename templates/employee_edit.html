{% extends "base.html" %}
{% block title %}Edit Employee{% endblock %}
{% block content %}
<div style="max-width:600px; margin:20px auto; padding:20px; border:1px solid #ccc; border-radius:8px; background:#fff;">
  <h2>Edit Employee</h2>

  <select id="template-select" style="width:100%; padding:8px; margin-bottom:15px;"></select>

  <form id="employee-form">
    <div id="dynamic-fields"></div>
    <button type="submit" style="padding:10px 15px; margin-top:15px; border:none; border-radius:4px; background:#4CAF50; color:white;">
      Save Changes
    </button>
  </form>
</div>

<script>
const employeeId = window.location.pathname.split('/')[3];
let templates = [];
let currentTemplate = null;

async function loadTemplates() {
  const token = localStorage.getItem('access_token');
  const res = await axios.get('/api/forms/', {
    headers: { Authorization: `Bearer ${token}` }
  });
  templates = res.data;

  const select = document.getElementById('template-select');
  select.innerHTML = '';

  templates.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.text = t.name;
    select.appendChild(opt);
  });

  await loadEmployee(); // Load employee after templates
}

async function loadEmployee() {
  const token = localStorage.getItem('access_token');
  const res = await axios.get(`/api/employees/${employeeId}/`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const employee = res.data;
  const select = document.getElementById('template-select');
  const template = templates.find(t => t.id === employee.form);

  if (template) {
    select.value = template.id;
    currentTemplate = template;
    renderForm(template, employee.data);
  }

  select.addEventListener('change', () => {
    const newTemplate = templates.find(x => x.id == select.value);
    currentTemplate = newTemplate;
    renderForm(newTemplate, {}); // clear data when changing template
  });
}

function renderForm(template, values = {}) {
  const container = document.getElementById('dynamic-fields');
  container.innerHTML = '';

  template.fields.forEach(f => {
    const div = document.createElement('div');
    div.style = 'margin-bottom:10px;';
    const val = values[f.label] || '';
    div.innerHTML = `
      <label>${f.label}:
        <input name="${f.label}" data-label="${f.label}" type="${f.type}" value="${val}"
          style="width:100%; padding:8px; border:1px solid #aaa; border-radius:4px;">
      </label>
    `;
    container.appendChild(div);
  });
}

document.getElementById('employee-form').addEventListener('submit', async e => {
  e.preventDefault();
  const token = localStorage.getItem('access_token');
  const formId = document.getElementById('template-select').value;

  const inputs = document.querySelectorAll('#dynamic-fields input');
  const data = {};
  inputs.forEach(i => data[i.dataset.label] = i.value);

  try {
    await axios.put(`/api/employees/${employeeId}/`, { form: formId, data }, {
      headers: { Authorization: `Bearer ${token}` }
    });
    alert('Employee updated successfully');
    window.location = '/employees/list/';
  } catch (err) {
    if (err.response) {
      let msg = '';
      for (let key in err.response.data) msg += `${key}: ${err.response.data[key]}\n`;
      alert(`Error updating employee:\n${msg}`);
    } else {
      alert('Error updating employee');
    }
  }
});

loadTemplates();
</script>
{% endblock %}
